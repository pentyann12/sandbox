<!doctype html>
<html lang="ja">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Todo</title>
    <!-- Vue 3 CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <!-- sql.js (wasm) CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.13.0/sql-wasm.js"></script>
    <!-- Bootstrap 5 CSS & JS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        body {
            font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
            margin: 0;
            padding: 0;
        }

        .app {
            max-width: 900px;
            margin: 24px auto;
            padding: 16px;
        }

        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .projects {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin: 12px 0;
        }

        .project {
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            color: #fff
        }

        .todo {
            border-bottom: 1px solid #eee;
            padding: 8px 0;
            display: flex;
            justify-content: space-between;
        }

        .todo .meta {
            font-size: 12px;
            color: #666
        }

        .controls {
            display: flex;
            gap: 8px;
        }

        input,
        textarea,
        select {
            padding: 6px;
            font-size: 14px
        }

        .tag {
            background: #eee;
            padding: 2px 6px;
            border-radius: 4px;
            margin-right: 4px;
            font-size: 12px
        }
    </style>
</head>

<body>
    <div id="app" class="app container">
        <header class="d-flex align-items-center justify-content-between mb-4">
            <h1 class="h3">Todo</h1>
            <div class="btn-group">
                <button class="btn btn-outline-secondary btn-sm" @click="exportDB">DBをエクスポート</button>
                <button class="btn btn-outline-secondary btn-sm" @click="importDBPrompt">DBをインポート</button>
            </div>
        </header>

        <section class="mb-4">
            <h2 class="h5">Projects</h2>
            <div class="row">
                <div class="col-md-8">
                    <ul class="list-group">
                        <li v-for="p in projects" :key="p.id" @click="selectProject(p.id)"
                            :class="['list-group-item','list-group-item-action','d-flex','justify-content-between','align-items-center', { active: p.id === currentProjectId }]">
                            <span>{{p.name}}</span>
                            <div class="d-flex gap-2 align-items-center">
                                <span class="badge" :style="{background:p.color}">&nbsp;</span>
                                <button class="btn btn-sm btn-outline-danger"
                                    @click.stop="deleteProject(p.id)">削除</button>
                            </div>
                        </li>
                    </ul>
                </div>
                <div class="col-md-4">
                    <div class="input-group input-group-sm">
                        <input v-model="newProjectName" class="form-control" placeholder="新しいプロジェクト名" />
                        <input type="color" v-model="newProjectColor" class="form-control form-control-color"
                            style="width:48px" />
                        <button class="btn btn-primary" @click="createProject">作成</button>
                    </div>
                </div>
            </div>
        </section>

        <section>
            <div class="d-flex justify-content-between align-items-center mb-2">
                <!-- <h2 class="h5 mb-0">Todos — プロジェクト: <span class="badge bg-secondary">{{currentProjectName}}</span></h2> -->
                <div class="input-group input-group-sm" style="width:480px">
                    <input v-model="filterText" class="form-control" placeholder="フィルタ" style="width: 200px;" />
                    <select v-model.number="selectedTagFilter" class="form-select" style="width:140px">
                        <option :value="0">タグ: すべて</option>
                        <option v-for="tg in tags" :key="tg.id" :value="tg.id">{{tg.name}}</option>
                    </select>
                    <select v-model.number="filterStatus" class="form-select" style="width:140px">
                        <option :value="-1">すべて</option>
                        <option :value="0">未完了</option>
                        <option :value="1">完了</option>
                        <option :value="2">アーカイブ</option>
                    </select>
                </div>
            </div>

            <div class="row gy-2">
                <div v-for="t in filteredTodos" :key="t.id" class="col-12">
                    <div :class="['card', isOverdue(t) ? 'border border-danger' : '']">
                        <div class="card-body d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="card-title mb-1">{{t.title}} <span class="ms-2"><span class="badge"
                                            :class="statusBadgeClass(t.status)">{{statusLabel(t.status)}}</span></span>
                                    <span v-if="isOverdue(t)" class="badge bg-danger ms-2">期限切れ</span>
                                </h6>
                                <p class="card-text text-muted small mb-1">{{t.description}}</p>
                                <div class="small text-muted">優先度: {{priorityLabel(t.priority)}} • {{t.due_date}}</div>
                                <div class="mt-1">
                                    <span v-for="tg in todoTags(t.id)" :key="tg.id"
                                        class="badge bg-light text-dark me-1">{{tg.name}}</span>
                                </div>
                            </div>
                            <div class="btn-group-vertical btn-group-sm ms-3">
                                <button class="btn btn-outline-success" @click="toggleComplete(t)">{{t.status===1 ?
                                    '未完了に戻す' : '完了'}}</button>
                                <button class="btn btn-outline-primary" @click="openEdit(t)">編集</button>
                                <button class="btn btn-outline-secondary" @click="archiveTodo(t)">アーカイブ</button>
                                <button class="btn btn-outline-danger" @click="deleteTodo(t.id)">削除</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card my-3">
                <div class="card-body">
                    <h3 class="h6">新規タスク</h3>
                    <div class="row g-2">
                        <div class="col-md-6">
                            <input v-model="form.title" class="form-control form-control-sm" placeholder="タイトル" />
                        </div>
                        <div class="col-md-3">
                            <input v-model="form.due_date" type="datetime-local" class="form-control form-control-sm" />
                        </div>
                        <div class="col-md-3">
                            <select v-model.number="form.priority" class="form-select form-select-sm">
                                <option :value="0">低</option>
                                <option :value="1">中</option>
                                <option :value="2">高</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <textarea v-model="form.description" class="form-control form-control-sm"
                                placeholder="詳細"></textarea>
                        </div>
                        <div class="col-12 d-flex gap-2 align-items-center">
                            <label class="mb-0 small me-2">タグ:</label>
                            <select v-model.number="selectedTagToAdd" class="form-select form-select-sm"
                                style="width:220px">
                                <option :value="0">-- 追加するタグを選択 --</option>
                                <option v-for="tg in tags" :key="tg.id" :value="tg.id">{{tg.name}}</option>
                            </select>
                            <button class="btn btn-sm btn-outline-secondary" @click="addTagToForm">追加</button>
                            <div>
                                <span v-for="tid in formTags" :key="tid"
                                    class="badge bg-info text-dark me-1">{{(tags.find(x=>x.id===tid)||{}).name}} <button
                                        class="btn-close btn-close-white btn-sm ms-2" aria-label="削除"
                                        @click="formTags = formTags.filter(x=>x!==tid)"></button></span>
                            </div>
                        </div>
                        <div class="col-12 mt-2">
                            <button class="btn btn-sm btn-success" @click="createTodo">追加</button>
                            <button v-if="editing" class="btn btn-sm btn-primary" @click="updateTodo">更新</button>
                            <button v-if="editing" class="btn btn-sm btn-secondary" @click="cancelEdit">キャンセル</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section style="margin-top:24px">
            <h2 class="h5">タグ管理</h2>
            <div>
                <div class="input-group input-group-sm mb-2" style="max-width:420px">
                    <input v-model="newTagName" class="form-control" placeholder="新しいタグ名" />
                    <button class="btn btn-primary" @click="createTag">タグ作成</button>
                </div>
                <div>
                    <span v-for="tg in tags" :key="tg.id" class="badge bg-secondary me-1">{{tg.name}} <button
                            class="btn-close btn-close-white btn-sm ms-2" aria-label="削除"
                            @click="deleteTag(tg.id)"></button></span>
                </div>
            </div>
        </section>

        <input type="file" id="importFile" style="display:none" @change="handleImportFile" />
    </div>

    <script>
        const { createApp, ref, reactive, onMounted, onBeforeUnmount, computed } = Vue;

        createApp({
            setup() {
                const SQL = window.initSqlJs;
                const dbRef = ref(null);

                // UI state
                const projects = ref([]);
                const todos = ref([]);
                const tags = ref([]);
                const todoTagMap = ref([]);

                const currentProjectId = ref(null);
                const newProjectName = ref('New Project');
                const newProjectColor = ref('#3b82f6');

                const filterText = ref('');
                const filterStatus = ref(-1);
                const selectedTagFilter = ref(0); // 0 = all, otherwise tag id

                const form = reactive({ id: null, title: '', description: '', status: 0, priority: 1, due_date: '', project_id: null });
                const editing = ref(false);

                const selectedTagToAdd = ref(0);
                const formTags = ref([]);
                const newTagName = ref('');

                // helpers
                function priorityLabel(v) { return ['低', '中', '高'][v] || '不明'; }
                function statusLabel(s) { return s === 0 ? '未完了' : (s === 1 ? '完了' : (s === 2 ? 'アーカイブ' : '不明')); }
                function statusBadgeClass(s) { return s === 0 ? 'bg-warning text-dark' : (s === 1 ? 'bg-success' : (s === 2 ? 'bg-secondary' : 'bg-light')); }
                function isOverdue(t) {
                    if (!t.due_date) return false;
                    if (t.status === 1 || t.status === 2) return false; // completed or archived
                    const due = new Date(t.due_date);
                    const now = new Date();
                    return due < now;
                }

                function run(sql, params = []) {
                    const db = dbRef.value; if (!db) throw new Error('DB not ready');
                    return db.exec(sql, params);
                }

                // DB init
                async function initDB() {
                    const SQLLib = await SQL({ locateFile: file => 'https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.13.0/sql-wasm.wasm' });
                    // load from localStorage
                    const b64 = localStorage.getItem('todoapp_db');
                    if (b64) {
                        const binary = Uint8Array.from(atob(b64), c => c.charCodeAt(0));
                        dbRef.value = new SQLLib.Database(binary);
                    } else {
                        dbRef.value = new SQLLib.Database();
                        createSchema();
                        seedDefault();
                        saveToLocalStorage();
                    }
                    await refreshAll();
                }

                function createSchema() {
                    const db = dbRef.value;
                    db.run(`CREATE TABLE IF NOT EXISTS project (id INTEGER PRIMARY KEY AUTOINCREMENT, name TEXT, color TEXT, created_at DATETIME DEFAULT CURRENT_TIMESTAMP);`);
                    db.run(`CREATE TABLE IF NOT EXISTS tag (id INTEGER PRIMARY KEY AUTOINCREMENT, name TEXT);`);
                    db.run(`CREATE TABLE IF NOT EXISTS todo (id INTEGER PRIMARY KEY AUTOINCREMENT, project_id INTEGER, title TEXT, description TEXT, status INTEGER DEFAULT 0, priority INTEGER DEFAULT 1, due_date DATETIME, created_at DATETIME DEFAULT CURRENT_TIMESTAMP, updated_at DATETIME DEFAULT CURRENT_TIMESTAMP);`);
                    db.run(`CREATE TABLE IF NOT EXISTS todo_tag (todo_id INTEGER, tag_id INTEGER, PRIMARY KEY (todo_id, tag_id));`);
                }

                function seedDefault() {
                    const db = dbRef.value;
                    db.run(`INSERT INTO project (name, color) VALUES ('Default', '#6b7280');`);
                    db.run(`INSERT INTO tag (name) VALUES ('home'), ('work');`);
                }

                function saveToLocalStorage() {
                    const db = dbRef.value; if (!db) return;
                    const data = db.export();
                    const b64 = btoa(String.fromCharCode.apply(null, data));
                    localStorage.setItem('todoapp_db', b64);
                    console.log('DB saved to LocalStorage', b64.length, 'bytes');
                }

                function exportDB() {
                    const db = dbRef.value; if (!db) return alert('DB not ready');
                    const data = db.export();
                    const blob = new Blob([data], { type: 'application/octet-stream' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url; a.download = 'todoapp.sqlite'; a.click();
                    URL.revokeObjectURL(url);
                }

                function importDBPrompt() {
                    document.getElementById('importFile').click();
                }

                function handleImportFile(e) {
                    const f = e.target.files[0];
                    if (!f) return;
                    const reader = new FileReader();
                    reader.onload = function () {
                        const arr = new Uint8Array(reader.result);
                        dbRef.value = new window.SQL.Database(arr);
                        saveToLocalStorage();
                        refreshAll();
                        alert('DBをインポートしました');
                    };
                    reader.readAsArrayBuffer(f);
                }

                async function refreshAll() {
                    // read projects
                    const pRes = dbRef.value.exec('SELECT id, name, color, created_at FROM project ORDER BY id');
                    projects.value = (pRes[0] ? pRes[0].values.map(r => ({ id: r[0], name: r[1], color: r[2], created_at: r[3] })) : []);
                    if (currentProjectId.value === null && projects.value.length) currentProjectId.value = projects.value[0].id;

                    const tRes = dbRef.value.exec('SELECT id, project_id, title, description, status, priority, due_date, created_at, updated_at FROM todo ORDER BY id DESC');
                    todos.value = (tRes[0] ? tRes[0].values.map(r => ({ id: r[0], project_id: r[1], title: r[2], description: r[3], status: r[4], priority: r[5], due_date: r[6], created_at: r[7], updated_at: r[8] })) : []);

                    const tgRes = dbRef.value.exec('SELECT id, name FROM tag ORDER BY id');
                    tags.value = (tgRes[0] ? tgRes[0].values.map(r => ({ id: r[0], name: r[1] })) : []);

                    const mapRes = dbRef.value.exec('SELECT todo_id, tag_id FROM todo_tag');
                    todoTagMap.value = (mapRes[0] ? mapRes[0].values.map(r => ({ todo_id: r[0], tag_id: r[1] })) : []);
                }

                function selectProject(id) { currentProjectId.value = id; }

                const currentProjectName = computed(() => {
                    const p = projects.value.find(x => x.id === currentProjectId.value);
                    return p ? p.name : '未選択';
                });

                const filteredTodos = computed(() => {
                    return todos.value.filter(t => {
                        if (currentProjectId.value && t.project_id !== currentProjectId.value) return false;
                        if (filterStatus.value >= 0 && t.status !== filterStatus.value) return false;
                        // tag filter
                        if (selectedTagFilter.value && selectedTagFilter.value !== 0) {
                            const ids = todoTagMap.value.filter(x => x.todo_id === t.id).map(x => x.tag_id);
                            if (!ids.includes(selectedTagFilter.value)) return false;
                        }
                        if (filterText.value && !(t.title.includes(filterText.value) || (t.description || '').includes(filterText.value))) return false;
                        return true;
                    });
                });

                function todoTags(todoId) {
                    const ids = todoTagMap.value.filter(x => x.todo_id === todoId).map(x => x.tag_id);
                    return tags.value.filter(t => ids.includes(t.id));
                }

                // CRUD
                function createProject() {
                    const name = newProjectName.value.trim(); if (!name) return;
                    dbRef.value.run('INSERT INTO project (name, color) VALUES (?, ?)', [name, newProjectColor.value]);
                    saveToLocalStorage(); refreshAll();
                }

                function deleteProject(id) {
                    if (!confirm('プロジェクトを削除しますか？ これに紐づくタスクも全て削除されます。')) return;
                    // delete todos and their todo_tag entries
                    dbRef.value.run('DELETE FROM todo_tag WHERE todo_id IN (SELECT id FROM todo WHERE project_id=?)', [id]);
                    dbRef.value.run('DELETE FROM todo WHERE project_id=?', [id]);
                    dbRef.value.run('DELETE FROM project WHERE id=?', [id]);
                    saveToLocalStorage();
                    // update currentProjectId if needed
                    refreshAll();
                    // if current deleted project was selected, clear or pick another
                    if (currentProjectId.value === id) {
                        currentProjectId.value = projects.value.length ? projects.value[0].id : null;
                    }
                }

                function createTag() {
                    const name = newTagName.value.trim(); if (!name) return;
                    dbRef.value.run('INSERT INTO tag (name) VALUES (?)', [name]);
                    newTagName.value = ''; saveToLocalStorage(); refreshAll();
                }

                function createTodo() {
                    const title = form.title.trim(); if (!title) return alert('タイトルが必要です');
                    const proj = currentProjectId.value || (projects.value[0] && projects.value[0].id) || null;
                    dbRef.value.run(`INSERT INTO todo (project_id, title, description, status, priority, due_date) VALUES (?,?,?,?,?,?)`, [proj, title, form.description, form.status, form.priority, form.due_date || null]);
                    // get last insert id
                    const idRow = dbRef.value.exec('SELECT last_insert_rowid()')[0].values[0][0];
                    const newId = idRow;
                    // attach tags
                    formTags.value.forEach(tid => {
                        dbRef.value.run('INSERT OR IGNORE INTO todo_tag (todo_id, tag_id) VALUES (?,?)', [newId, tid]);
                    });
                    // clear form
                    form.title = ''; form.description = ''; form.due_date = ''; form.priority = 1; form.status = 0; formTags.value = [];
                    saveToLocalStorage(); refreshAll();
                }

                function addTagToForm() { if (selectedTagToAdd.value) { if (!formTags.value.includes(selectedTagToAdd.value)) formTags.value.push(selectedTagToAdd.value); selectedTagToAdd.value = 0; } }

                function openEdit(t) {
                    editing.value = true; form.id = t.id; form.title = t.title; form.description = t.description; form.status = t.status; form.priority = t.priority; form.due_date = t.due_date; form.project_id = t.project_id;
                    // load tags
                    formTags.value = todoTagMap.value.filter(x => x.todo_id === t.id).map(x => x.tag_id);
                }

                function cancelEdit() { editing.value = false; Object.assign(form, { id: null, title: '', description: '', status: 0, priority: 1, due_date: '', project_id: null }); formTags.value = []; }

                function updateTodo() {
                    if (!form.id) return;
                    dbRef.value.run('UPDATE todo SET title=?, description=?, status=?, priority=?, due_date=?, updated_at=CURRENT_TIMESTAMP WHERE id=?', [form.title, form.description, form.status, form.priority, form.due_date || null, form.id]);
                    // sync tags: remove all then insert
                    dbRef.value.run('DELETE FROM todo_tag WHERE todo_id=?', [form.id]);
                    formTags.value.forEach(tid => dbRef.value.run('INSERT OR IGNORE INTO todo_tag (todo_id, tag_id) VALUES (?,?)', [form.id, tid]));
                    saveToLocalStorage(); refreshAll(); cancelEdit();
                }

                function toggleComplete(t) {
                    const next = t.status === 1 ? 0 : 1; dbRef.value.run('UPDATE todo SET status=?, updated_at=CURRENT_TIMESTAMP WHERE id=?', [next, t.id]); saveToLocalStorage(); refreshAll();
                }

                function archiveTodo(t) { dbRef.value.run('UPDATE todo SET status=2, updated_at=CURRENT_TIMESTAMP WHERE id=?', [t.id]); saveToLocalStorage(); refreshAll(); }

                function deleteTodo(id) { if (!confirm('削除しますか？')) return; dbRef.value.run('DELETE FROM todo WHERE id=?', [id]); dbRef.value.run('DELETE FROM todo_tag WHERE todo_id=?', [id]); saveToLocalStorage(); refreshAll(); }

                function deleteTag(id) { if (!confirm('タグを削除しますか？')) return; dbRef.value.run('DELETE FROM tag WHERE id=?', [id]); dbRef.value.run('DELETE FROM todo_tag WHERE tag_id=?', [id]); saveToLocalStorage(); refreshAll(); }

                // lifecycle
                onMounted(() => {
                    initDB().catch(e => { console.error(e); alert('DB初期化に失敗しました'); });
                    window.addEventListener('beforeunload', saveToLocalStorage);
                });

                onBeforeUnmount(() => { saveToLocalStorage(); window.removeEventListener('beforeunload', saveToLocalStorage); });

                // expose
                return {
                    projects, todos, tags, todoTagMap, currentProjectId, newProjectName, newProjectColor,
                    filterText, filterStatus, selectedTagFilter, form, editing, priorityLabel, selectProject, currentProjectName,
                    filteredTodos, todoTags, createProject, createTag, createTodo, addTagToForm, selectedTagToAdd, formTags,
                    openEdit, cancelEdit, updateTodo, toggleComplete, archiveTodo, deleteTodo, deleteTag, deleteProject, newTagName,
                    exportDB, importDBPrompt, handleImportFile, statusBadgeClass, statusLabel, isOverdue
                };
            }
        }).mount('#app');
    </script>
</body>

</html>